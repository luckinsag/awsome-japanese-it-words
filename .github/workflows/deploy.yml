name: Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  EC2_IP: ${{ secrets.EC2_IP }}
  EC2_USER: ${{ secrets.EC2_USER }}
  KEY_FILE: ./deploy-key.pem

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Test Backend
      run: |
        cd itwords_api
        mvn test
      continue-on-error: false
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: itwords_display/package-lock.json
    
    - name: Test Frontend
      run: |
        cd itwords_display
        npm ci
        npm run build
      continue-on-error: false

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: itwords_display/package-lock.json
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Create EC2 key file
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > $KEY_FILE
        chmod 400 $KEY_FILE
    
    - name: Build and push Docker images
      env:
        DOCKER_DEFAULT_PLATFORM: linux/amd64
      run: |
        # æ„å»ºåç«¯é•œåƒ
        echo "æ„å»ºåç«¯é•œåƒ..."
        docker compose build --no-cache backend
        if [ $? -ne 0 ]; then
          echo "âŒ åç«¯é•œåƒæ„å»ºå¤±è´¥"
          exit 1
        fi
        
        # æ„å»ºå‰ç«¯é•œåƒ
        echo "æ„å»ºå‰ç«¯é•œåƒ..."
        docker compose build --no-cache frontend
        if [ $? -ne 0 ]; then
          echo "âŒ å‰ç«¯é•œåƒæ„å»ºå¤±è´¥"
          exit 1
        fi
        
        # è·å–æ­£ç¡®çš„é•œåƒåç§°
        BACKEND_IMAGE=$(docker compose images -q backend)
        FRONTEND_IMAGE=$(docker compose images -q frontend)
        
        # éªŒè¯é•œåƒID
        if [ -z "$BACKEND_IMAGE" ]; then
          echo "âŒ æ— æ³•è·å–åç«¯é•œåƒID"
          exit 1
        fi
        if [ -z "$FRONTEND_IMAGE" ]; then
          echo "âŒ æ— æ³•è·å–å‰ç«¯é•œåƒID"
          exit 1
        fi
        
        echo "åç«¯é•œåƒID: $BACKEND_IMAGE"
        echo "å‰ç«¯é•œåƒID: $FRONTEND_IMAGE"
        
        # ä¿å­˜é•œåƒ
        mkdir -p deploy-images
        docker save $BACKEND_IMAGE -o deploy-images/backend.tar
        docker save $FRONTEND_IMAGE -o deploy-images/frontend.tar
        tar -czf deploy-images.tar.gz -C deploy-images .
    
    - name: Deploy to EC2
      run: |
        # æ£€æŸ¥EC2è¿æ¥
        echo "æ£€æŸ¥EC2è¿æ¥..."
        ssh -i $KEY_FILE -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_IP "echo 'EC2è¿æ¥æˆåŠŸ'" || {
          echo "âŒ æ— æ³•è¿æ¥åˆ°EC2å®ä¾‹"
          exit 1
        }
        
        # ä¼ è¾“é•œåƒ
        echo "ä¼ è¾“é•œåƒæ–‡ä»¶..."
        scp -i $KEY_FILE -o StrictHostKeyChecking=no deploy-images.tar.gz $EC2_USER@$EC2_IP:~/itwords-images/ || {
          echo "âŒ é•œåƒæ–‡ä»¶ä¼ è¾“å¤±è´¥"
          exit 1
        }
        
        # åˆ›å»ºéƒ¨ç½²é…ç½®æ–‡ä»¶
        cat > deploy-compose.yml << 'EOF'
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: itwords-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: xcx981211
      MYSQL_DATABASE: mysql_itwordslearning
      MYSQL_USER: itwords_user
      MYSQL_PASSWORD: itwords_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - itwords-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  backend:
    image: backend:latest
    container_name: itwords-backend
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/mysql_itwordslearning?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Tokyo&useUnicode=true&characterEncoding=utf8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: xcx981211
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    volumes:
      - backend_logs:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - itwords-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: frontend:latest
    container_name: itwords-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - itwords-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  mysql_data:
    driver: local
  backend_logs:
    driver: local

networks:
  itwords-network:
    driver: bridge
EOF

        # ä¼ è¾“é…ç½®æ–‡ä»¶
        scp -i $KEY_FILE -o StrictHostKeyChecking=no deploy-compose.yml $EC2_USER@$EC2_IP:~/itwords-images/
        scp -i $KEY_FILE -o StrictHostKeyChecking=no scripts/data-processing/init.sql $EC2_USER@$EC2_IP:~/itwords-images/init.sql 2>/dev/null || echo "init.sql ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        scp -i $KEY_FILE -o StrictHostKeyChecking=no complete_wordlist.csv $EC2_USER@$EC2_IP:~/itwords-images/ 2>/dev/null || echo "complete_wordlist.csv ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        
        # åœ¨EC2ä¸Šéƒ¨ç½²
        ssh -i $KEY_FILE -o StrictHostKeyChecking=no $EC2_USER@$EC2_IP '
            cd ~/itwords-images
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            docker compose -f deploy-compose.yml down -v 2>/dev/null || true
            docker system prune -f
            
            # è§£å‹å¹¶åŠ è½½é•œåƒ
            tar -xzf deploy-images.tar.gz
            docker load -i backend.tar
            docker load -i frontend.tar
            
            # è·å–åŠ è½½çš„é•œåƒåç§°ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
            BACKEND_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^[^/]+backend:" | head -1)
            FRONTEND_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^[^/]+frontend:" | head -1)
            
            echo "åŠ è½½çš„åç«¯é•œåƒ: $BACKEND_IMAGE"
            echo "åŠ è½½çš„å‰ç«¯é•œåƒ: $FRONTEND_IMAGE"
            
            # éªŒè¯é•œåƒåç§°
            if [ -z "$BACKEND_IMAGE" ]; then
                echo "âŒ æ— æ³•æ‰¾åˆ°åç«¯é•œåƒ"
                exit 1
            fi
            if [ -z "$FRONTEND_IMAGE" ]; then
                echo "âŒ æ— æ³•æ‰¾åˆ°å‰ç«¯é•œåƒ"
                exit 1
            fi
            
            # æ›´æ–°deploy-compose.ymlä¸­çš„é•œåƒåç§°
            sed -i "s|image: backend:latest|image: $BACKEND_IMAGE|g" deploy-compose.yml
            sed -i "s|image: frontend:latest|image: $FRONTEND_IMAGE|g" deploy-compose.yml
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f *.tar deploy-images.tar.gz
            
            # å¯åŠ¨åº”ç”¨
            docker compose -f deploy-compose.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆåŠ¨æ€ç­‰å¾…ï¼‰
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            for i in {1..30}; do
                if docker compose -f deploy-compose.yml ps | grep -q "Up"; then
                    echo "âœ… æœåŠ¡å·²å¯åŠ¨"
                    break
                fi
                echo "ç­‰å¾…ä¸­... ($i/30)"
                sleep 10
            done
            
            # æ£€æŸ¥çŠ¶æ€
            docker compose -f deploy-compose.yml ps
            
            # æµ‹è¯•è¿æ¥
            echo "æµ‹è¯•æœåŠ¡è¿æ¥..."
            for i in {1..6}; do
                if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                    echo "âœ… åç«¯APIè¿æ¥æˆåŠŸ"
                    break
                fi
                echo "ç­‰å¾…åç«¯API... ($i/6)"
                sleep 10
            done
            
            for i in {1..6}; do
                if curl -f http://localhost 2>/dev/null; then
                    echo "âœ… å‰ç«¯è¿æ¥æˆåŠŸ"
                    break
                fi
                echo "ç­‰å¾…å‰ç«¯... ($i/6)"
                sleep 10
            done
        '
    
    - name: Verify deployment
      run: |
        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        echo "ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
        for i in {1..12}; do
            if curl -f http://$EC2_IP:8080/actuator/health 2>/dev/null; then
                echo "âœ… åç«¯APIå¤–éƒ¨è®¿é—®æˆåŠŸ"
                break
            fi
            echo "ç­‰å¾…åç«¯APIå¤–éƒ¨è®¿é—®... ($i/12)"
            sleep 10
        done
        
        # æµ‹è¯•å¤–éƒ¨è®¿é—®
        echo "æµ‹è¯•å¤–éƒ¨è®¿é—®..."
        if curl -f http://$EC2_IP:8080/actuator/health 2>/dev/null; then
            echo "âœ… åç«¯APIå¤–éƒ¨è®¿é—®æˆåŠŸ"
        else
            echo "âŒ åç«¯APIå¤–éƒ¨è®¿é—®å¤±è´¥"
            exit 1
        fi
        
        if curl -f http://$EC2_IP 2>/dev/null; then
            echo "âœ… å‰ç«¯å¤–éƒ¨è®¿é—®æˆåŠŸ"
        else
            echo "âŒ å‰ç«¯å¤–éƒ¨è®¿é—®å¤±è´¥"
            exit 1
        fi
    
    - name: Cleanup
      if: always()
      run: |
        rm -f $KEY_FILE
        rm -rf deploy-images
        rm -f deploy-images.tar.gz
    
    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ åº”ç”¨åœ°å€: http://$EC2_IP"
          echo "ğŸ”§ åç«¯API: http://$EC2_IP:8080"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
        fi 